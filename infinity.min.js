!function(a){"use strict";var b=function(b,c){this.element=a(b),this.pageData=[],this.startIndex=0,this.mbook="",this.isEnd=!1,this.pointer=0,this._init(c)};b.settings={ajaxUrl:"",container:".timeline",template:"",buffer:1,callback:null},b.prototype={_init:function(c){this.options=a.extend(!0,{},b.settings,c),this.template=this.options.template,this.buffer=this.options.buffer,this.container=this.element.find(this.options.container),this.callback=this.options.callback,this.scrollView(),this.bindEvent()},scrollView:function(){var a=this,b=new mScroll(a.element[0],{pullUp:".pull-up",downCallBack:function(){a.resetParam(),a.probeData()},upCallBack:function(){a.isEnd||a.getData()}});a.scroll=b,b=null},bindEvent:function(){var b=this,c=b.element;c.on("scrollend",function(){var c=null,d=b.scroll.scrollPage.y;d=Math.abs(d),b.probeData(d),c=setTimeout(function(){try{a(".lazy").lazyload.detect()}catch(b){}},0)})},getData:function(){var b=this;a.ajax({url:b.options.ajaxUrl,data:{mbook:b.mbook},success:function(a){if(1001===a.status.code){var c=a.result;c.list.length<=0&&0==b.startIndex&&b.noContent(),b.appendPage(c),b.updateParam(c)}else console.log("\u6570\u636e\u683c\u5f0f\u4e0d\u5bf9!")},error:function(){console.log("\u7f51\u7edc\u8fde\u63a5\u51fa\u9519\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5!")}})},appendPage:function(b){var c=this,d=c.startIndex,e="";e+="<div class='branch on' data-page="+d+">",e+=doT.template(c.template)(b),e+="</div>",0==d?c.container.html(e):c.container.append(e),c.lazyloadImg(),c.scroll&&c.scroll.refresh(),c.callback&&a.isFunction(c.callback)&&c.callback(b,d),d=null},noContent:function(){var a=this,b="<div class='no-content'><p>\u6682\u65e0\u5185\u5bb9</p></div>";a.element.html(b)},updateParam:function(a){this.mbook=a.mbook,this.isEnd=a.isEnd,this.startIndex++,this.pageData.push({list:a.list}),this.hideMore()},resetParam:function(){this.pageData=[],this.startIndex=0,this.mbook="",this.isEnd=!1,this.pointer=0},hideMore:function(){this.isEnd&&this.element.find(".pull-up").hide()},fillPage:function(b,c){var d=this,e=doT.template(d.template)(c);b.html(e),b.addClass("on").removeClass("off"),b.find("img").each(function(){var b=a(this),c=b.attr("data-original");c&&""!=c&&b.attr("src",c)})},clearPage:function(a){a.css("height",a.height()),a.addClass("off").removeClass("on"),a.empty()},probeData:function(b){var c=this,d=b+window.innerHeight/2;0==c.pageData.length&&c.getData();var e=c.element.find(".branch");e.each(function(){var f=a(this)[0],g=f.offsetHeight,h=f.offsetTop;(h+g>d&&d>h||h+g>b&&b>h)&&(c.pointer=parseInt(a(this).attr("data-page")))});var f=c.pointer-c.buffer,g=c.pointer+c.buffer;0==c.pointer&&(f=0),console.log("page:"+f+" > "+g),c.showScreen(f,g)},showScreen:function(a,b){for(var c=this,d=c.pageData.length,e=0;d>e;e++){var f=c.element.find('.branch[data-page="'+e+'"]');e>=a&&b>=e?0===f.children().length&&c.fillPage(f,c.pageData[e]):f.children().length>0&&c.clearPage(f)}},lazyloadImg:function(){var b=this;a(".lazy").lazyload({container:b.element,innerScroll:!0})}},window.infinity=b}(window.Zepto);